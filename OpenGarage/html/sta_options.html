<head>
  <title>OpenGarage Options</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <link rel='stylesheet' href='http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css' type='text/css'>
  <script src='http://code.jquery.com/jquery-1.9.1.min.js' type='text/javascript'></script>
  <script src='http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js' type='text/javascript'></script>
</head>
<body>
  <div data-role='page' id='page_opts'>
    <div data-role='header'><h3>Edit Options</h3></div>    
    <div data-role='content'>   
      <table cellpadding=2>
      <tr><td><b>Accessibility:</b></td><td>
      <select name='acc' id='acc' data-mini='true'>
      <option value=0>Direct IP Only</option>
      <option value=1>Direct IP + Cloud</option>                  
      <option value=2>Cloud Only</option>
      </select></td></tr>      
      <tr><td><b>Cloud Token:</b></td><td><input type='text' size=24 maxlength=32 id='auth' data-mini='true' value='-'></td></tr>
      <tr><td><b>MQTT Server:</b></td><td><input type='text' size=24 maxlength=64 id='mqs' data-mini='true' value=''></td></tr>
      <tr><td><b>MQTT Port:</b></td><td><input type='text' size=5 maxlength=5 id='mqp' value=1883 data-mini='true'></td></tr>
      <tr><td><b>MQTT Username:</b></td><td><input type='text' size=24 maxlength=64 id='mqu' data-mini='true'></td></tr>
      <tr><td><b>MQTT Password:</b></td><td><input type='password' size=24 maxlength=64 id='mqw' data-mini='true'></td></tr>
      <tr><td><b>MQTT Status Topic:</b></td><td><input type='text' size=24 maxlength=64 id='mqts' data-mini='true' value='home/garage/status'></td></tr>
      <tr><td><b>MQTT Command Topic:</b></td><td><input type='text' size=24 maxlength=64 id='mqtc' data-mini='true' value='home/garage/command'></td></tr>
      <tr><td><b>Mount Type:</b></td><td>
      <select name='mnt' id='mnt' data-mini='true'>
      <option value=0>Ceiling Mount</option>
      <option value=1>Side Mount</option>
      </select></td></tr> 
      <tr><td><b>Threshold (cm): </b></td><td><input type='text' size=4 maxlength=4 id='dth' data-mini='true' value=0></td></tr>
      <tr><td><b>Read Interval (s):</b></td><td><input type='text' size=3 maxlength=3 id='riv' data-mini='true' value=0></td></tr>
      <tr><td><b>Click Time (ms):</b></td><td><input type='text' size=5 maxlength=5 id='cdt' value=0 data-mini='true'></td></tr>
      <tr><td><b>Sound Alarm:</b></td><td>
      <select name='alm' id='alm' data-mini='true'>      
      <option value=0>Disabled</option>
      <option value=1>5 seconds</option>                  
      <option value=2>10 seconds</option>      
      </select></td></tr>
      <tr><td><b>Device Name:</b></td><td><input type='text' size=20 maxlength=32 id='name' data-mini='true' value='-'></td></tr>
      <tr><td><b>HTTP Port:</b></td><td><input type='text' size=5 maxlength=5 id='htp' value=0 data-mini='true'></td></tr>
      <tr><td><b>IFTTT Key:<a href='#ifttInfo' data-rel='popup' data-role='button' data-inline='true' data-transition='pop' data-icon='info' data-theme='c' data-iconpos='notext'>Learn more</a><div data-role='popup' id='ifttInfo' class='ui-content' data-theme='b' style='max-width:320px;'>
  <p><a href='https://ifttt.com' target='_blank'>IFTTT</a> provides additional notification options (e.g. SMS, email) besides Blynk.</p>
</div></b></td><td><input type='text' size=24 maxlength=64 id='iftt' data-mini='true' value='-'></td></tr>      
      <tr><td><b>Automation:</b></td><td>If door is open for more than</td></tr>
      <tr><td colspan=2>
      <table><tr><td><input type='text' size=3 maxlength=3 id='ati' value=30 data-mini='true'></td><td>minutes:</td><td><input type='checkbox' id='ato0' data-mini='true'><label for='ato0'>Notify me</label></td><td><input type='checkbox' id='ato1' data-mini='true'><label for='ato1'>Auto-close</label></td></tr></table>
      </td></tr>
      <tr><td><b>Device Key:</b></td><td><input type='password' size=24 maxlength=32 id='dkey' data-mini='true'></td></tr>
      
      <tr><td colspan=2><p id='msg'></p></td></tr>
      </table>
      <div data-role='controlgroup' data-type='horizontal'>
      <a href='#' data-role='button' data-inline='true' data-theme='a' id='btn_back'>Back</a>
      <a href='#' data-role='button' data-inline='true' data-theme='b' id='btn_submit'>Submit</a>      
      </div>
      <table>
      <tr><td colspan=2><input type='checkbox' data-mini='true' id='cb_key'><label for='cb_key'>Change Device Key</label></td></tr>
      <tr><td><b>New Key:</b></td><td><input type='password' size=24 maxlength=32 id='nkey' data-mini='true' disabled></td></tr>
      <tr><td><b>Confirm:</b></td><td><input type='password' size=24 maxlength=32 id='ckey' data-mini='true' disabled></td></tr>      
      </table>
    </div>
    <div data-role='footer' data-theme='c'>
      <p>&nbsp; OpenGarage Firmware <label id='fwv'>-</label>&nbsp;<a href='update' target='_top' data-role='button' data-inline=true data-mini=true>Update</a></p>
    </div> 
  </div>
  <script>
    function clear_msg() {$('#msg').text('');}  
    function show_msg(s) {$('#msg').text(s).css('color','red'); setTimeout(clear_msg, 2000);}
    function goback() {history.back();}
    function eval_cb(n)  {return $(n).is(':checked')?1:0;}
    $('#cb_key').click(function(e){
      $('#nkey').textinput($(this).is(':checked')?'enable':'disable');
      $('#ckey').textinput($(this).is(':checked')?'enable':'disable');
    });
    $('#btn_back').click(function(e){
      e.preventDefault(); goback();
    });
    $('#btn_submit').click(function(e){
      e.preventDefault();
      if(confirm('Submit changes?')) {
        var comm='co?dkey='+encodeURIComponent($('#dkey').val());
        comm+='&acc='+$('#acc').val();
        comm+='&mnt='+$('#mnt').val();
        comm+='&dth='+$('#dth').val();
        comm+='&riv='+$('#riv').val();
        comm+='&alm='+$('#alm').val();
        comm+='&htp='+$('#htp').val();
        comm+='&cdt='+$('#cdt').val();
        comm+='&ati='+$('#ati').val();
        var ato=0;
        for(var i=1;i>=0;i--) { ato=(ato<<1)+eval_cb('#ato'+i); }
        comm+='&ato='+ato;
        comm+='&name='+encodeURIComponent($('#name').val());
        comm+='&auth='+encodeURIComponent($('#auth').val());
        comm+='&iftt='+encodeURIComponent($('#iftt').val());
        comm+='&mqs='+encodeURIComponent($('#mqs').val());
        comm+='&mqp='+$('#mqp').val();
        comm+='&mqu='+encodeURIComponent($('#mqu').val());
        comm+='&mqw='+encodeURIComponent($('#mqw').val());
        comm+='&mqts='+encodeURIComponent($('#mqts').val());
        comm+='&mqtc='+encodeURIComponent($('#mqtc').val());
        if($('#cb_key').is(':checked')) {
          if(!$('#nkey').val()) {
            if(!confirm('New device key is empty. Are you sure?')) return;
          }
          comm+='&nkey='+encodeURIComponent($('#nkey').val());
          comm+='&ckey='+encodeURIComponent($('#ckey').val());
        }
        $.getJSON(comm, function(jd) {
          if(jd.result!=1) {
            if(jd.result==2) show_msg('Check device key and try again.');
            else show_msg('Error code: '+jd.result+', item: '+jd.item);
          } else {
            $('#msg').html('<font color=green>Options are successfully saved. Note that<br>changes to some options may require a reboot.</font>');
            setTimeout(goback, 4000);
          }
        });
      }
    });
    $(document).ready(function() {
      $.getJSON('jo', function(jd) {
        $('#fwv').text('v'+(jd.fwv/100>>0)+'.'+(jd.fwv/10%10>>0)+'.'+(jd.fwv%10>>0));
        $('#acc').val(jd.acc).selectmenu('refresh');
        $('#alm').val(jd.alm).selectmenu('refresh');
        $('#mnt').val(jd.mnt).selectmenu('refresh');
        $('#dth').val(jd.dth);
        $('#riv').val(jd.riv);
        $('#htp').val(jd.htp);
        $('#cdt').val(jd.cdt);
        $('#ati').val(jd.ati);
        for(var i=0;i<=1;i++) {if(jd.ato&(1<<i)) $('#ato'+i).attr('checked',true).checkboxradio('refresh');}
        $('#name').val(jd.name);
        $('#auth').val(jd.auth);
        $('#iftt').val(jd.iftt);
        $('#mqs').val(jd.mqs);
        $('#mqp').val(jd.mqp);
        $('#mqu').val(jd.mqu);
        $('#mqw').val(jd.mqw);
        $('#mqts').val(jd.mqts);
        $('#mqtc').val(jd.mqtc);
      });
    });
  </script>
</body>

